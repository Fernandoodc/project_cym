{% extends "base.html" %}

{% block title %}Inicios{% endblock %}

{% block content %}

<div class="pagetitle">
  <h1>Producción</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Incio</a></li>
      <li class="breadcrumb-item active">Orden de Trabajo</li>
      <li class="breadcrumb-item active">Producción</li>
    </ol>
  </nav>
</div><!-- End Page Title -->

<section class="section dashboard">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Detalles</h5>
          <div class="row mb-3">
            <label for="codProduccion" class="col-sm-4 col-form-label">Codigo de Producción</label>
            <div class="col-sm-8">
              <input type="text" class="form-control" id="codProduccion" disabled value="{{producto.codProduccion}}">
            </div>
          </div>
          <div class="row mb-3">
            <label for="producto" class="col-sm-4 col-form-label">Producto</label>
            <div class="col-sm-8">
              <input type="text" class="form-control" id="producto" disabled value="{{producto.producto}}">
            </div>
          </div>
          <div class="row mb-3">
            <label for="descripcion" class="col-sm-4 col-form-label">Descripción</label>
            <div class="col-sm-8">
              <textarea class="form-control" name="descripcion" id="descripcion"disabled>{{producto.descripcion}}</textarea>
            </div>
          </div>
          {% set aux = '' %}
          {% if producto.detalleProducto.metodoCalculo.codMetodo >= 2 %}
            <div id="dimensiones" class="row mb-3">
            {% if producto.detalleProducto.metodoCalculo.codMetodo == 2 %}
                <label class="col-sm-2 col-form-label">Dimensiones cm2</label> 
                <div class="col-sm-5">
                  <label for="inputText" class="col-sm-3 col-form-label">Ancho</label>
                  <input type="number" class="form-control" id="ancho" disabled value="{{producto.detalleProducto.medidas.ancho}}">
                </div>
                <div class="col-sm-4">
                  <label for="inputText" class="col-sm-3 col-form-label">Alto</label>
                  <input type="number" class="form-control" id="alto" disabled value="{{producto.detalleProducto.medidas.alto}}">
                </div>
            {% else %}
              {% if producto.detalleProducto.metodoCalculo.codMetodo == 3 %}
                  <label class="col-sm-2 col-form-label">Dimensiones mt2</label>
                  <div class="col-sm-5">
                    <label for="inputText" class="col-sm-3 col-form-label">Ancho</label>
                    <input type="number" class="form-control" id="ancho" disabled value="{{producto.detalleProducto.medidas.ancho}}">
                  </div>
                  <div class="col-sm-4">
                    <label for="inputText" class="col-sm-3 col-form-label">Alto</label>
                    <input type="number" class="form-control" id="alto" disabled value="{{producto.detalleProducto.medidas.alto}}">
                  </div>
              {% else %}
                  {% if producto.detalleProducto.metodoCalculo.codMetodo == 4 %}
                      <label class="col-sm-2 col-form-label">Dimensiones cm3</label>
                      <div class="col-sm-3">
                        <label for="inputText" class="col-form-label">Ancho</label>
                        <input type="number" class="form-control" id="ancho" disabled value="{{producto.detalleProducto.medidas.ancho}}">
                      </div>
                      <div class="col-sm-3">
                        <label for="inputText" class="col-form-label">Alto</label>
                        <input type="number" class="form-control" id="alto" disabled value="{{producto.detalleProducto.medidas.alto}}">
                      </div>
                      <div class="col-sm-3">
                        <label for="inputText" class="col-form-label">Profundidad</label>
                        <input type="number" class="form-control" id="Producidad" disabled value="{{producto.detalleProducto.medidas.profundidad}}">
                      </div>
                  {% endif %}
              {% endif %}
            {% endif %}
            </div>
          {% endif %}
          <div class="row mb-3">
            <label for="inputText" class="col-sm-2 col-form-label">Archivos</label>
            <div class="col-sm-10">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Archivos</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="infoArchivos">
                          {% for archivo in producto.archivos %}
                              <tr class="">
                                  <td scope="row"><a href="/files?ruta={{archivo.ruta}}" >{{archivo.nombre}}</a></td>
                                  <td><a class="btn btn-primary" href="/files/download?ruta={{archivo.ruta}}&filename={{archivo.nombre}}" role="button">Descargar</a></td>
                              </tr>
                          {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
          <div class="row mb-3">
            <label for="inputText" class="col-sm-2 col-form-label">Diseños</label>
            <div class="col-sm-10">
                <div class="table-responsive">
                    <table class="table table-hover" id="tableDiseños">
                        <thead>
                            <tr>
                                <th scope="col">Diseños</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="infoDisenios">
                          {% for diseño in producto.diseños %}
                            <tr class="">
                                <td scope="row"><a href="/files?ruta={{diseño.ruta}}" >{{diseño.descripcion}}</a></td>
                                <td><a class="btn btn-primary" href="/files/download?ruta={{diseño.ruta}}&filename={{diseño.descripcion}}" role="button">Descargar</a></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
          <h5 class="card-title">Estado</h5>
          <p class="text-center" id="progreso-p">{{producto.cantidad - producto.cantidadRestante}} de {{producto.cantidad}}</p>
          <div class="progress mt-3 mb-3" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progreso" role="progressbar" style="width: {{((producto.cantidad - producto.cantidadRestante)*100 / producto.cantidad)}}%"></div>
          </div>
          <div class="row mb-3">
            <label for="terminado" class="col-sm-2 col-form-label">Terminado ahora:</label>
            <div class="col-sm-3">
              <input type="number" min="0" max="{{producto.cantidadRestante}}" class="form-control" id="terminado">
            </div>
            <div class="col-sm-5" id="botonesEstado">
              <button type="button" id="guardarTerminados" class="btn btn-primary">Guardar</button>
              {% if producto.cantidad == producto.cantidadRestante %}
                <button type="button" id="cancelarProduccion" class="btn btn-secondary">Cancelar Producción</button>
              {% else %}
                {% if producto.etapa.codEtapa == 1 %}
                  <button type="button" class="btn btn-secondary" id="pausar-openModal" data-bs-toggle="modal" data-bs-target="#pausar-modal">Pausar Produccion</button>
                {% endif %}
              {% endif %}
              <!-- Modal trigger button -->
              <div class="modal fade" id="pausar-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="pausar" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm" role="document">
                  <div class="modal-content">
                    <div class="modal-body">
                      <p>¿Desea pausar la Producción?<p>
                      <small>Se restablecera el stock de insumos aun no utilizados</small>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="button" class="btn btn-primary" id="pausarProduccion">Pausar</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Modal Body -->
              <!-- if you want to close by clicking outside the modal, delete the last endpoint:data-bs-backdrop and data-bs-keyboard -->
              <div class="modal fade" id="terminado-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="terminado" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm" role="document">
                  <div class="modal-content">
                    <div class="modal-body">
                      <p class="display-1 text-center" ><i class="ri-checkbox-circle-line" style="color: #800c95;"></i></p>
                      <p class="text-center">Producción terminada</p>
                      <p class="text-center"> <span id="producido">0</span> de <span id="total">0</span></p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" id="btn-terminar" class="btn btn-primary">OK</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Insumos</h5>
          <ul class="list-group list-group-numbered mb-3">
            {% for insumo in producto.insumos %}
            <li class="list-group-item">{{insumo.descripcion}}</li>
            {% endfor%}
          </ul>
          <button type="button" id="solicitarInsumo-btn" class="btn btn-primary" data-bs-toggle="modal" id="inforPerdida" data-bs-target="#perdida-modal">
            Solicitar Insumos 
          </button>
            <div class="modal fade" id="perdida-modal" tabindex="-1">
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Solicitar insumos a causa de una perdida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">   
                    <div id="newCliente">
                          <div class="alert" id="alertPedida"></div>
                          <div class="row mb-3">
                            <label for="insumos" class="col-sm-2 col-form-label">Insumo:</label>
                            <div class="col-sm-10">
                              <select class="form-select form-select-sm" name="insumo" id="insumo">
                                {% for insumo in producto.insumos %}
                                  {% if insumo.tipoInsumo_id == 1 %}
                                    <option value="{{insumo.codInsumo}}">{{insumo.codInsumo}}  - {{insumo.descripcion}}</option>
                                  {% endif %}
                                {% endfor%}
                              </select>
                            </div>
                          </div>
                          <div class="row mb-3">
                            <label for="cantidadPerdidad" class="col-sm-2 col-form-label">Cantidad:</label>
                            <div class="col-sm-10">
                              <input type="number" name="cantidadPerdidad" id="cantidadPerdidad" class="form-control">
                            </div>
                          </div>
                          <div class="row mb-3">
                            <label for="comentarios" class="col-form-label col-sm-2">Comentarios</label>
                            <div class="col-sm-10">
                              <textarea name="comentarios" id="comentarios" class="form-control"></textarea>
                            </div>
                          </div>   
                          <div class="modal-footer">
                            <button type="button" id="solicitarInsumo" class="btn btn-success">Guardar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button> 
                          </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <h5 class="card-title mt-3">Insumos Perdidos</h5>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Insumos</th>
                  <th scope="col">Cant.</th>
                </tr>
              </thead>
              <tbody>
                {% for perdido in insumosPerdidos %}
                <tr>
                  <td>{{perdido.insumo.descripcion}}</td>
                  <td>{{perdido.cantidad}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='/js/jquery-3.6.1.min.js') }}"></script>
<script src="{{ url_for('static', path='/js/funciones_ajax.js') }}"></script>
<script src="{{ url_for('static', path='/js/produccion.js') }}"></script>

  <script>
    const codProduccion = {{producto.codProduccion | tojson}}
  </script>
{% endblock %}